services:
    orchestrator:
        container_name: orchestrator
        build:
            context: .
            dockerfile: ./packages/orchestrator/Dockerfile
        ports:
            - '3000:3000'
        networks:
            - webwisp
        depends_on:
            rabbitmq:
                condition: service_healthy
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
            interval: 1m30s
            timeout: 30s
            retries: 5
            start_period: 30s
        environment:
            - FORCE_COLOR=1
            - LOG_LEVEL=debug
            - RABBITMQ_HOST=rabbitmq

    rabbitmq:
        image: rabbitmq:3-management
        ports:
            - '5672:5672'
            - '15672:15672'
        networks:
            - webwisp
        environment:
            - RABBITMQ_DEFAULT_USER=guest
            - RABBITMQ_DEFAULT_PASS=guest
        container_name: rabbitmq
        healthcheck:
            test: ['CMD', 'rabbitmqctl', 'status']
            interval: 10s
            timeout: 10s
            retries: 3

    worker:
        build:
            context: .
            dockerfile: ./packages/worker/Dockerfile
        deploy:
            mode: replicated
            replicas: 2
        networks:
            - webwisp
        depends_on:
            rabbitmq:
                condition: service_healthy
        restart: on-failure
        environment:
            - FORCE_COLOR=1
            - LOG_LEVEL=debug
            - RABBITMQ_HOST=rabbitmq
            - OPENAI_CONFIG_FILE=/run/secrets/openai-config
        secrets:
            - openai-config

networks:
    webwisp:
        driver: bridge

secrets:
    openai-config:
        file: ./.secrets/openai.json
